<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Santa's Suit-Up Dash</title>
    <style>
        :root {
            --primary-color: #C62828;
            --accent-color: #1B5E20;
            --gold: #FFC107;
        }

        body {
            background-color: #f0f4f8;
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            overflow-y: auto; 
            padding: 20px;
        }

        #game-wrapper {
            display: flex;
            gap: 20px;
            align-items: center;
            margin-top: 20px;
            flex-wrap: wrap;
            justify-content: center;
            max-width: 1400px;
        }

        #board-container {
            width: 700px;
            height: auto; 
            position: relative;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px; 
        }
        
        #board-base {
            position: absolute; 
            top: 350px; left: 50%; 
            width: 700px; 
            height: 700px;
            transform: translate(-50%, -50%);
            border-radius: 20px; 
            box-shadow: none; 
            z-index: 0;
            background-color: transparent;
            border: none;
            background-size: contain; 
            background-position: center;
            background-repeat: no-repeat;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #888;
            font-weight: bold;
            font-size: 20px;
            text-align: center;
            line-height: 1.5;
        }
        
        #board-base.no-image {
            border: 5px dashed #ccc;
            background-color: #eee;
            border-radius: 50%; 
            width: 600px;
            height: 600px;
        }

        svg {
            width: 700px; height: 700px;
            position: relative;
            z-index: 10;
            filter: none;
        }

        .cell { 
            cursor: pointer; 
            transition: all 0.2s; 
            fill: transparent;
            stroke: transparent;
            stroke-width: 15px; 
            stroke-linejoin: round;
        }
        .cell:hover { 
            stroke: rgba(255, 215, 0, 0.6); 
            stroke-width: 8px;
            filter: drop-shadow(0 0 5px gold);
            z-index: 100; 
        }
        
        .emoji-icon, .label-text {
            display: block; 
            pointer-events: none;
        }
        
        .image-mode .emoji-icon, 
        .image-mode .label-text {
            display: none !important;
        }

        .debug-id {
            display: none;
            font-size: 16px;
            fill: #fff;
            stroke: #000;
            stroke-width: 3px;
            paint-order: stroke;
            font-weight: bold;
            pointer-events: none;
            text-anchor: middle;
            dominant-baseline: central;
        }
        .show-ids .debug-id {
            display: block !important;
        }
        .show-ids .cell {
            stroke: rgba(255, 255, 255, 0.3);
            stroke-width: 2px;
        }
        
        .label-text {
            font-size: 14px;
            fill: #333;
            text-transform: uppercase;
            font-weight: 800;
            text-shadow: 1px 1px 0 #fff;
        }

        #inner-layer-group { transform-origin: 500px 500px; }

        .elf-token {
            stroke: white; stroke-width: 3px;
            filter: drop-shadow(0 3px 5px rgba(0,0,0,0.4));
            pointer-events: none; transition: cx 0.5s, cy 0.5s;
        }

        #dashboard {
            width: 340px;
            height: auto;
            min-height: 700px;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #ddd;
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            position: relative;
        }

        h2 { color: var(--primary-color); margin-bottom: 5px; font-weight: 800; letter-spacing: 1px; }
        .subtitle { color: #555; font-size: 0.95em; margin-bottom: 20px; font-style: italic; text-align: center; }
        
        #player-controls {
            display: flex; gap: 10px; margin-bottom: 15px;
            background: #eee; padding: 10px; border-radius: 50px;
        }
        .player-btn {
            width: 40px; height: 40px; border-radius: 50%;
            border: 3px solid transparent; cursor: pointer;
            transition: transform 0.2s; display: flex; align-items: center; justify-content: center;
            font-size: 20px; background-color: white;
        }
        .player-btn:hover { transform: scale(1.1); }
        .player-btn.active { border-color: #333; transform: scale(1.2); z-index: 10; box-shadow: 0 0 10px rgba(0,0,0,0.2); }
        .player-btn.frozen { opacity: 0.5; cursor: not-allowed; border-color: #00BCD4; background: #E0F7FA; }
        
        .p-blue { background: #42A5F5; color: white; }
        .p-yellow { background: #FFEE58; color: #555; }
        .p-pink { background: #EC407A; color: white; }
        .p-purple { background: #AB47BC; color: white; }

        #dice-area { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
        #dice-btn {
            padding: 10px 20px; background: #FF5722; color: white;
            border: none; border-radius: 10px; cursor: pointer;
            font-weight: bold; font-size: 16px; box-shadow: 0 4px 0 #E64A19;
        }
        #dice-btn:active { transform: translateY(4px); box-shadow: none; }
        #dice-btn:disabled { background: #ccc; cursor: not-allowed; box-shadow: none; transform: none; }
        
        #dice-display {
            width: 50px; height: 50px; background: white;
            border: 2px solid #ccc; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 28px; font-weight: bold; color: #333;
        }

        #message-box {
            width: 100%; padding: 10px; margin-bottom: 15px;
            background: linear-gradient(135deg, #FFFDE7, #FFF9C4);
            border-left: 5px solid #FFB300; border-radius: 8px;
            font-size: 0.9em; color: #444; min-height: 50px;
            display: flex; align-items: center; justify-content: center; text-align: center;
        }

        /* --- ğŸ… è–èª•è€äººè®Šè£å€ --- */
        #santa-stage {
            width: 280px; height: 380px;
            position: relative; background: #E1F5FE; 
            border-radius: 15px; border: 4px solid white;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.1);
            margin-bottom: 20px; overflow: hidden;
        }
        
        /* åœ–ç‰‡åœ–å±¤çš„é€šç”¨æ¨£å¼ */
        .santa-layer { 
            position: absolute; 
            left: 50%; 
            transform: translateX(-50%); 
            transition: all 0.5s; 
            pointer-events: none; 
        }
        
        /* åŸºåº•ä½ç½® */
        .base-body { width: 180px; bottom: 20px; z-index: 1; }
        
        /* å„éƒ¨ä½èª¿æ•´ */
        #layer-Pants { width: 100px; bottom: 55px; z-index: 5; }
        #layer-Boots { width: 110px; bottom: 20px; z-index: 6; }
        
        /* èª¿æ•´ 1 & 4: è¡£æœå’Œçš®å¸¶è®Šå° */
        #layer-Coat { width: 100px; bottom: 115px; z-index: 7; }
        #layer-Belt { width: 100px; bottom: 125px; z-index: 8; }
        
        #layer-Hat { width: 100px; top: 40px; z-index: 9; }
        
        /* èª¿æ•´ 2: æ‰‹å¥—æ”¹åˆ°è·Ÿè¡£æœåŒé«˜ä½†é å³ */
        #layer-Mittens { 
            width: 70px; 
            top: auto; 
            bottom: 120px; /* ç´„èˆ‡è¡£æœåŒé«˜ */
            right: 20px; 
            left: auto;
            transform: none;
            z-index: 12; 
        }
        
        /* èª¿æ•´ 3: é›ªæ©‡èˆ‡é¦´é¹¿ä½ç½®å°èª¿ */
        /* é›ªæ©‡åœ¨å·¦ */
        #layer-Sleigh { width: 120px; bottom: 10px; left: 10px; right: auto; z-index: 10; transform: translateX(0); }
        /* é¦´é¹¿åœ¨å³ */
        #layer-Reindeer { width: 100px; bottom: 10px; right: -20px; left: auto; z-index: 10; transform: translateX(0); }
        
        #layer-Presents { 
            width: 70px; 
            top: 20px; 
            left: 20px; 
            bottom: auto;
            transform: none;
            z-index: 12; 
        }

        /* é¡¯ç¤º/éš±è—å‹•ç•«é¡åˆ¥ */
        .hidden-gear { opacity: 0; transform: translateX(-50%) scale(0.5); }
        .visible-gear { opacity: 1; transform: translateX(-50%) scale(1); }
        
        /* å´é‚Šç‰©å“çš„ç‰¹æ®Šéš±è—ä½ç½® (ä¸ç½®ä¸­) - é…åˆæ–°ä½ç½®èª¿æ•´éš±è—æ–¹å‘ */
        #layer-Sleigh.hidden-gear { transform: translateX(-50px) scale(0.5); opacity: 0; } /* å¾€å·¦éš±è— */
        #layer-Sleigh.visible-gear { transform: translateX(0) scale(1); opacity: 1; }
        
        #layer-Reindeer.hidden-gear { transform: translateX(50px) scale(0.5); opacity: 0; } /* å¾€å³éš±è— */
        #layer-Reindeer.visible-gear { transform: translateX(0) scale(1); opacity: 1; }

        /* ç‰¹æ®Šä½ç½®ç‰©å“çš„é¡¯ç¤º/éš±è—è¦†å¯« */
        #layer-Mittens.visible-gear, #layer-Presents.visible-gear {
            transform: scale(1);
            opacity: 1;
        }
        #layer-Mittens.hidden-gear, #layer-Presents.hidden-gear {
            transform: scale(0.5);
            opacity: 0;
        }

        #gear-grid { 
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;
            width: 100%; margin-bottom: 20px;
        }
        .gear-badge {
            background: #fff; border-radius: 8px; padding: 5px; text-align: center; font-size: 10px; color: #999;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: all 0.3s;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 70px; border: 1px solid #eee;
        }
        .gear-badge.active {
            background: linear-gradient(135deg, #66BB6A, #43A047); color: white; 
            transform: scale(1.05); box-shadow: 0 4px 8px rgba(0,0,0,0.2); border: none;
        }
        .gear-img-icon { width: 35px; height: 35px; object-fit: contain; margin-bottom: 5px; }
        .gear-icon { font-size: 24px; margin-bottom: 5px; }
        
        .btn-group { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; justify-content: center; }
        .btn { padding: 8px 16px; background: #546E7A; color: white; border: none; border-radius: 20px; cursor: pointer; }
        .btn:hover { background: #455A64; }
        .btn-rules { background: var(--primary-color); }
        .btn-rules:hover { background: #B71C1C; }
        .btn-config { background: #7B1FA2; }
        .btn-config:hover { background: #4A148C; }
        .btn-download { background: #00897B; }
        .btn-download:hover { background: #00695C; }
        
        #toggle-ids {
            font-size: 12px; margin-top: 5px; cursor: pointer; color: #666; text-decoration: underline;
        }

        #rules-modal {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 2000;
            justify-content: center; align-items: center;
        }
        .modal-content {
            background: white; width: 90%; max-width: 600px;
            padding: 30px; border-radius: 15px;
            position: relative;
            max-height: 90vh; overflow-y: auto;
            border-top: 10px solid var(--accent-color);
        }
        .close-btn {
            position: absolute; top: 15px; right: 20px;
            font-size: 24px; cursor: pointer; color: #999;
        }
        .close-btn:hover { color: #333; }
        .rules-title { text-align: center; color: var(--accent-color); margin-bottom: 20px; font-size: 1.5em; border-bottom: 2px dashed #eee; padding-bottom: 10px; }
        .rules-columns {
            column-count: 2;
            column-gap: 30px;
            column-rule: 1px solid #eee;
        }
        .rule-block {
            break-inside: avoid;
            margin-bottom: 20px;
            background: #f9f9f9; padding: 10px; border-radius: 8px;
        }
        .rule-num { color: var(--primary-color); font-weight: bold; font-size: 1.2em; margin-right: 5px; }
        .rule-head { font-weight: bold; color: #333; display: block; margin-bottom: 5px; }
        .rule-text { color: #666; font-size: 0.9em; line-height: 1.4; }

        @media (max-width: 600px) {
            .rules-columns { column-count: 1; }
            #board-container { transform: scale(0.5); margin-bottom: -350px; margin-top: -150px; }
            #game-wrapper { gap: 0; }
        }
    </style>
</head>
<body>

<div id="game-wrapper">
    <div id="board-container">
        <div id="board-base" class="no-image">
            1. ä¸Šå‚³åœ–ç‰‡ (Image)<br>2. ä¸Šå‚³è¨­å®š (Config)<br><br>
            â†˜ é»æ“Šå³å´æŒ‰éˆ• â†˜
        </div>
        <svg id="game-board" viewBox="0 0 1000 1000">
            <g id="outer-layer-group"></g>
            <g id="inner-layer-group"></g>
            <g id="token-layer"></g>
        </svg>
        <div id="toggle-ids" onclick="toggleDebugIds()">[ğŸ‘ï¸ é¡¯ç¤º/éš±è— æ ¼å­ç·¨è™Ÿ]</div>
    </div>

    <div id="dashboard">
        <h2>Santa's Suit-Up Dash</h2>
        <div class="subtitle">Work together! Help Santa find his gear!</div>
        
        <div id="player-controls">
            <div class="player-btn p-blue active" onclick="setPlayer(0)" title="Blue Elf">ğŸ§</div>
            <div class="player-btn p-yellow" onclick="setPlayer(1)" title="Yellow Elf">ğŸ§â€â™€ï¸</div>
            <div class="player-btn p-pink" onclick="setPlayer(2)" title="Pink Elf">ğŸ§</div>
            <div class="player-btn p-purple" onclick="setPlayer(3)" title="Purple Elf">ğŸ§â€â™€ï¸</div>
        </div>

        <div id="dice-area">
            <button id="dice-btn" onclick="rollDice()">ğŸ² Roll Dice</button>
            <div id="dice-display">-</div>
        </div>

        <div id="message-box">è«‹ä¸Šå‚³æ‚¨çš„è½‰ç›¤åœ–ç‰‡ï¼<br>Please upload board image.</div>

        <div id="santa-stage">
            <!-- åŸºåº•åœ–ç‰‡ -->
            <img id="base-santa-img" class="santa-layer base-body" alt="Santa Base" onerror="this.style.display='none'; document.getElementById('backup-santa').style.display='flex';">
            
            <!-- å‚™ç”¨ Emoji -->
            <div id="backup-santa" class="santa-layer base-body" style="display:none; width:100%; height:100%; flex-direction:column; justify-content:center; align-items:center; bottom:0;">
                <div style="font-size:80px">ğŸ…</div>
                <div style="font-size:50px; margin-top:-20px">ğŸ‘•</div>
            </div>
        </div>

        <div id="gear-grid"></div>
        
        <div class="btn-group">
            <input type="file" id="board-upload" accept="image/*" style="display:none" onchange="loadBoardImage(this)">
            <button class="btn" onclick="document.getElementById('board-upload').click()" style="background:#E64A19;">ğŸ–¼ï¸ ä¸Šå‚³åº•åœ–</button>
            
            <input type="file" id="config-upload" accept=".txt,.json" style="display:none" onchange="loadConfig(this)">
            <button class="btn btn-config" onclick="document.getElementById('config-upload').click()">ğŸ“„ ä¸Šå‚³è¨­å®š</button>
            
            <button class="btn btn-rules" onclick="toggleRules()">ğŸ“œ Rules</button>
            <button class="btn btn-download" onclick="downloadGame()">ğŸ“¥ ä¸‹è¼‰</button>
        </div>
    </div>
</div>

<div id="rules-modal" onclick="if(event.target === this) toggleRules()">
    <div class="modal-content">
        <span class="close-btn" onclick="toggleRules()">&times;</span>
        <h3 class="rules-title">ğŸ„ Cooperative Rules</h3>
        <div class="rules-columns">
            <div class="rule-block">
                <span class="rule-num">1.</span> <span class="rule-head">Mission (ç›®æ¨™)</span>
                <div class="rule-text"><b>Cooperate!</b> The 4 Elves must work together to collect all 9 items. You are a team!</div>
            </div>
            <div class="rule-block">
                <span class="rule-num">2.</span> <span class="rule-head">Movement (ç§»å‹•)</span>
                <div class="rule-text">Roll the dice ğŸ². Start from the <b>CENTER</b>! Choose one of the 4 paths to begin.</div>
            </div>
            <div class="rule-block">
                <span class="rule-num">3.</span> <span class="rule-head">Traps (é™·é˜±)</span>
                <div class="rule-text">
                    <b>Hole in Sock</b>: Team loses an item.<br>
                    <b>Snowman</b>: Freeze! Miss a turn.<br>
                    <b>Snowstorm</b>: Go back to center (Use this to switch paths!).
                </div>
            </div>
            <div class="rule-block">
                <span class="rule-num">4.</span> <span class="rule-head">Winning (å‹åˆ©)</span>
                <div class="rule-text">When the team lights up all 9 items, Santa is ready! Everyone wins together! ğŸ‰</div>
            </div>
        </div>
    </div>
</div>

<script>
    const players = [
        { color: '#42A5F5', name: 'Blue', id: 0, x: 500, y: 500, isSkipped: false },
        { color: '#FFEE58', name: 'Yellow', id: 1, x: 500, y: 500, isSkipped: false },
        { color: '#EC407A', name: 'Pink', id: 2, x: 500, y: 500, isSkipped: false },
        { color: '#AB47BC', name: 'Purple', id: 3, x: 500, y: 500, isSkipped: false }
    ];
    let currentPlayerId = 0;
    let collectedItems = new Set();

    // æ›´æ–° Assets è·¯å¾‘
    const assets = {
        "Hat": "img/collection/hat.png",
        "Coat": "img/collection/coat.png",
        "Belt": "img/collection/belt.png",
        "Pants": "img/collection/pants.png",
        "Boots": "img/collection/boots.png",
        "Mittens": "img/collection/mittens.png",
        "Sleigh": "img/collection/sleigh.png",
        "Reindeer": "img/collection/reindeer.png",
        "Presents": "img/collection/presents.png",
        "BaseSanta": "img/collection/base_santa.png"
    };

    const itemDB = {
        "coat": { type: "gear", icon: "ğŸ§¥", name: "Coat" },
        "pants": { type: "gear", icon: "ğŸ‘–", name: "Pants" },
        "hole in sock": { type: "trap", icon: "ğŸ•³ï¸", name: "Hole in Sock" },
        "mittens": { type: "gear", icon: "ğŸ§¤", name: "Mittens" },
        "reindeer": { type: "gear", icon: "ğŸ¦Œ", name: "Reindeer" },
        "belt": { type: "gear", icon: "ã€°ï¸", name: "Belt" },
        "snowstorm": { type: "trap", icon: "ğŸŒ€", name: "Snowstorm" },
        "sleigh": { type: "gear", icon: "ğŸ›·", name: "Sleigh" },
        "candy cane": { type: "bonus", icon: "ğŸ¬", name: "Candy Cane" },
        "boots": { type: "gear", icon: "ğŸ‘¢", name: "Boots" },
        "gingerbread": { type: "bonus", icon: "ğŸª", name: "Gingerbread" },
        "presents": { type: "gear", icon: "ğŸ", name: "Presents" },
        "stockings": { type: "bonus", icon: "ğŸ§¦", name: "Stockings" },
        "hat": { type: "gear", icon: "ğŸ§¢", name: "Hat" },
        "miss a turn": { type: "trap", icon: "ğŸ›‘", name: "Miss a Turn" },
        "snowman": { type: "trap", icon: "â›„", name: "Snowman" },
        "wreath": { type: "deco", icon: "ğŸ„", name: "Wreath" },
        "christmas tree": { type: "deco", icon: "ğŸ„", name: "Wreath" }, 
        "lost a piece": { type: "trap", icon: "ğŸ’¨", name: "Lost a Piece" },
        "move back 1 space": { type: "trap", icon: "ğŸ”™", name: "Move Back" },
        "move ahead 2 spaces": { type: "bonus", icon: "â©", name: "Move Ahead 2" },
        "back to the center": { type: "trap", icon: "ğŸŒ€", name: "Back to Center" },
        "star": { type: "bonus", icon: "â­", name: "Star" }
    };

    let outerDataMap = [
        "Coat", "Pants", "Hole in sock", "Mittens", "Reindeer", "Belt", "Snowstorm", "Sleigh",
        "Candy cane", "Boots", "Gingerbread", "Presents", "Stockings", "Snowstorm", "Snowstorm", "Hat"
    ];

    let innerDataMap = [
        ["Presents", "Coat", "Snowman"],           // TL (Index 0)
        ["Wreath", "Candy cane", "Sleigh"],       // TR (Index 1)
        ["Reindeer", "Hole in sock", "Boots"],    // BR (Index 2)
        ["Stockings", "Pants", "Mittens"]         // BL (Index 3)
    ];

    const innerGroup = document.getElementById('inner-layer-group');
    const outerGroup = document.getElementById('outer-layer-group');
    const tokenLayer = document.getElementById('token-layer');
    const gearGrid = document.getElementById('gear-grid');
    const msgBox = document.getElementById('message-box');
    const diceDisplay = document.getElementById('dice-display');
    const diceBtn = document.getElementById('dice-btn');
    const boardContainer = document.getElementById('board-container');
    const santaStage = document.getElementById('santa-stage');

    // æ¢å¾© initStage ä»¥ç”Ÿæˆåœ–ç‰‡æ¨™ç±¤
    function initStage() {
        const baseImg = document.getElementById('base-santa-img');
        baseImg.src = assets["BaseSanta"];

        const gearOrder = ["Pants", "Boots", "Coat", "Belt", "Hat", "Mittens", "Sleigh", "Reindeer", "Presents"];
        
        gearOrder.forEach(item => {
            const img = document.createElement('img');
            img.src = assets[item]; // ä½¿ç”¨ assets å…§çš„ img/collection/ è·¯å¾‘
            img.id = `layer-${item}`;
            
            // è¨­å®š class
            if(["Sleigh", "Reindeer"].includes(item)) { // Presents æ”¹ç‚ºå³ä¸Šè§’é¡¯ç¤ºï¼Œä¸è¦–ç‚ºå´é‚Šè£é£¾
                img.className = "santa-layer hidden-gear";
            } else {
                img.className = "santa-layer hidden-gear";
            }
            
            // é è¨­éš±è—ï¼Œè¼‰å…¥å¤±æ•—æ™‚(æœ¬æ©Ÿæ¸¬è©¦ç„¡åœ–)ä¹Ÿæœƒä¿æŒéš±è—
            img.onerror = function() { this.style.display = 'none'; };
            
            santaStage.appendChild(img);
        });
    }
    initStage(); // å‘¼å«åˆå§‹åŒ–

    function loadBoardImage(input) {
        if (input.files && input.files[0]) {
            var reader = new FileReader();
            reader.onload = function (e) {
                const boardBase = document.getElementById('board-base');
                boardBase.style.backgroundImage = "url('" + e.target.result + "')";
                boardBase.innerText = ""; 
                boardBase.style.border = "none";
                boardBase.classList.remove('no-image'); 
                boardContainer.classList.add('image-mode');
                msgBox.innerHTML = "Image Loaded! <br>Upload Config or Roll Dice to start.";
                msgBox.style.borderLeftColor = "#4CAF50";
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    function loadConfig(input) {
        if (input.files && input.files[0]) {
            var reader = new FileReader();
            reader.onload = function (e) {
                const text = e.target.result;
                parseConfig(text);
                refreshBoard(); 
                msgBox.innerHTML = "ğŸ“„ Config Loaded Successfully!";
                msgBox.style.borderLeftColor = "#9C27B0";
            };
            reader.readAsText(input.files[0]);
        }
    }

    function parseConfig(text) {
        const lines = text.split(/\r?\n/);
        lines.forEach(line => {
            const parts = line.split(':');
            if (parts.length >= 2) {
                const key = parts[0].trim().toUpperCase(); 
                const val = parts[1].trim(); 
                
                if (key.startsWith('O') && !isNaN(parseInt(key.substring(1)))) {
                    const idx = parseInt(key.substring(1)) - 1;
                    if (idx >= 0 && idx < 16) outerDataMap[idx] = val;
                }
                else {
                    let armIdx = -1;
                    // Mapping: TL=0, TR=1, BR=2, BL=3
                    if (key.startsWith('TL')) armIdx = 0;
                    else if (key.startsWith('TR')) armIdx = 1;
                    else if (key.startsWith('BR')) armIdx = 2;
                    else if (key.startsWith('BL')) armIdx = 3;

                    if (armIdx !== -1) {
                        const cellIdx = parseInt(key.substring(2)) - 1; 
                        if (cellIdx >= 0 && cellIdx < 3) {
                            innerDataMap[armIdx][cellIdx] = val;
                        }
                    }
                }
            }
        });
    }

    function getItemData(name) {
        if (!name) return { type: "bonus", icon: "â“", name: "Unknown" };
        const lowerName = name.toLowerCase();
        return itemDB[lowerName] || { type: "bonus", icon: "â“", name: name };
    }

    function refreshBoard() {
        outerGroup.innerHTML = '';
        innerGroup.innerHTML = '';
        
        for(let i=0; i<16; i++) {
            const data = getItemData(outerDataMap[i]);
            drawCell(i * (360/16) - 90, 360/16, 450, 360, data, outerGroup, `O${i+1}`);
        }

        // é †æ™‚é‡ä¿®æ­£ç‰ˆ
        const arms = [315, 45, 135, 225]; 
        const armCodes = ["TL", "TR", "BR", "BL"]; 
        const armSweep = 45;
        const layers = [
            { rOut: 360, rIn: 260 }, 
            { rOut: 260, rIn: 160 }, 
            { rOut: 160, rIn: 60 }   
        ]; 
        
        arms.forEach((armDeg, armIndex) => {
            const armData = innerDataMap[armIndex]; 
            layers.forEach((layer, layerIndex) => {
                const data = getItemData(armData[layerIndex]);
                const cellId = `${armCodes[armIndex]}${layerIndex+1}`;
                drawCell(armDeg - (armSweep/2) - 90, armSweep, layer.rOut, layer.rIn, data, innerGroup, cellId);
            });
        });
    }

    function createSectorPath(cx, cy, rOuter, rInner, startAngle, endAngle) {
        const rad = Math.PI / 180;
        const x1 = cx + rOuter * Math.cos(startAngle * rad), y1 = cy + rOuter * Math.sin(startAngle * rad);
        const x2 = cx + rOuter * Math.cos(endAngle * rad), y2 = cy + rOuter * Math.sin(endAngle * rad);
        const x3 = cx + rInner * Math.cos(endAngle * rad), y3 = cy + rInner * Math.sin(endAngle * rad);
        const x4 = cx + rInner * Math.cos(startAngle * rad), y4 = cy + rInner * Math.sin(startAngle * rad);
        const largeArc = (endAngle - startAngle) > 180 ? 1 : 0;
        return `M ${x1} ${y1} A ${rOuter} ${rOuter} 0 ${largeArc} 1 ${x2} ${y2} L ${x3} ${y3} A ${rInner} ${rInner} 0 ${largeArc} 0 ${x4} ${y4} Z`;
    }

    function drawCell(startDeg, sweepDeg, rOut, rIn, data, containerGroup, debugId) {
        const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
        const d = createSectorPath(500, 500, rOut, rIn, startDeg, startDeg + sweepDeg);
        
        path.setAttribute("d", d); 
        path.setAttribute("class", `cell`); 
        
        const midDeg = startDeg + sweepDeg / 2;
        const rMid = (rOut + rIn)/2;
        const cx = 500 + rMid * Math.cos(midDeg * Math.PI / 180);
        const cy = 500 + rMid * Math.sin(midDeg * Math.PI / 180);

        path.onclick = () => {
            const isInner = containerGroup.id === 'inner-layer-group';
            moveToken(currentPlayerId, cx, cy, isInner);
            handleGameAction(data);
        };
        containerGroup.appendChild(path);
        
        const group = document.createElementNS("http://www.w3.org/2000/svg", "g");
        group.setAttribute("transform", `translate(${cx}, ${cy}) rotate(${midDeg + 90})`);
        
        // Icon & Label
        const icon = document.createElementNS("http://www.w3.org/2000/svg", "text");
        icon.textContent = data.icon; icon.setAttribute("class", "emoji-icon"); icon.setAttribute("y", -8);
        group.appendChild(icon);
        
        const label = document.createElementNS("http://www.w3.org/2000/svg", "text");
        label.textContent = data.name; label.setAttribute("class", "label-text"); label.setAttribute("y", 20); 
        group.appendChild(label);

        const idText = document.createElementNS("http://www.w3.org/2000/svg", "text");
        idText.textContent = debugId; 
        idText.setAttribute("class", "debug-id");
        if(containerGroup.id === 'inner-layer-group') {
             idText.setAttribute("transform", `rotate(-${midDeg + 90})`);
        }
        group.appendChild(idText);
        
        group.setAttribute("pointer-events", "none");
        containerGroup.appendChild(group);
    }

    function toggleDebugIds() {
        boardContainer.classList.toggle('show-ids');
    }

    function downloadGame() {
        const htmlContent = document.documentElement.outerHTML;
        const blob = new Blob([htmlContent], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'santas_adventure_game.html';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    function toggleRules() {
        rulesModal.style.display = (rulesModal.style.display === 'flex') ? 'none' : 'flex';
    }

    const gearList = [
        { id: "Hat", icon: "ğŸ§¢" }, 
        { id: "Coat", icon: "ğŸ§¥" }, 
        { id: "Pants", icon: "ğŸ‘–" },
        { id: "Boots", icon: "ğŸ‘¢" }, 
        { id: "Belt", icon: "ã€°ï¸" }, 
        { id: "Mittens", icon: "ğŸ§¤" },
        { id: "Sleigh", icon: "ğŸ›·" }, 
        { id: "Reindeer", icon: "ğŸ¦Œ" }, 
        { id: "Presents", icon: "ğŸ" }
    ];

    gearList.forEach(item => {
        const div = document.createElement('div');
        div.className = 'gear-badge';
        div.id = `badge-${item.id}`;
        let emojiBackup = `<span class="gear-icon">${item.icon}</span>`;
        div.innerHTML = `${emojiBackup}<div style="font-weight:bold">${item.id}</div>`;
        gearGrid.appendChild(div);
    });

    refreshBoard();

    function initTokens() {
        players.forEach(p => {
            const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
            circle.setAttribute("cx", p.x); circle.setAttribute("cy", p.y);
            circle.setAttribute("r", 15);
            circle.setAttribute("fill", p.color);
            circle.setAttribute("class", "elf-token");
            circle.id = `token-${p.id}`;
            tokenLayer.appendChild(circle);
        });
    }
    initTokens();

    function setPlayer(id) {
        currentPlayerId = id;
        document.querySelectorAll('.player-btn').forEach(btn => {
            btn.classList.remove('active');
            if (players[btn.onclick.toString().match(/\d+/)[0]].isSkipped) {
                btn.classList.add('frozen');
            } else {
                btn.classList.remove('frozen');
            }
        });
        
        const currentBtn = document.querySelectorAll('.player-btn')[id];
        currentBtn.classList.add('active');
        
        if (players[id].isSkipped) {
            msgBox.innerHTML = `<span style="color:${players[id].color}">${players[id].name}</span> is <b>Frozen!</b> â›„ Skipping turn...`;
            msgBox.style.borderLeftColor = "#00BCD4";
            diceBtn.disabled = true;
            
            setTimeout(() => {
                players[id].isSkipped = false; 
                diceBtn.disabled = false;
                let nextId = (id + 1) % 4; 
                setPlayer(nextId);
            }, 2000);
        } else {
            diceBtn.disabled = false;
            msgBox.innerHTML = `Hi <span style="color:${players[id].color}; font-weight:bold">${players[id].name} Elf</span>! Roll the dice.`;
            msgBox.style.borderLeftColor = "#FFB300";
        }
    }

    function rollDice() {
        const num = Math.floor(Math.random() * 6) + 1;
        diceDisplay.textContent = num;
        msgBox.innerHTML = `Rolled a <b>${num}</b>! Move ${num} spaces.`;
    }

    function moveToken(playerId, x, y, isInner) {
        const offsetX = (playerId % 2 === 0 ? -10 : 10);
        const offsetY = (playerId < 2 ? -10 : 10);
        const token = document.getElementById(`token-${playerId}`);
        if (isInner) innerGroup.appendChild(token); else tokenLayer.appendChild(token);
        token.setAttribute("cx", x + offsetX);
        token.setAttribute("cy", y + offsetY);
    }

    function handleGameAction(data) {
        const player = players[currentPlayerId];
        const pName = `<span style="color:${player.color}">${player.name} Elf</span>`;

        if (data.type === 'trap') {
             if (data.name === "Hole in Sock" || data.name === "Lost a Piece") {
                if (collectedItems.size > 0) {
                    const itemsArray = Array.from(collectedItems);
                    const lostItem = itemsArray[Math.floor(Math.random() * itemsArray.length)];
                    collectedItems.delete(lostItem);
                    updateVisuals(lostItem, false);
                    msgBox.innerHTML = `${pName}: ğŸ•³ï¸ <b>${data.name}!</b> Team Lost ${lostItem}.`; 
                } else {
                    msgBox.innerHTML = `${pName}: ğŸ•³ï¸ <b>${data.name}!</b> (Safe! No items).`;
                }
             } else if (data.name === "Snowstorm" || data.name === "Back to Center") {
                 msgBox.innerHTML = `${pName}: ğŸŒ€ <b>Snowstorm!</b> Back to Center!`;
                 moveToken(currentPlayerId, 500, 500, false); 
             } else if (data.name === "Snowman" || data.name === "Miss a Turn") {
                 msgBox.innerHTML = `${pName}: â›„ <b>${data.name}!</b> Frozen next turn!`;
                 players[currentPlayerId].isSkipped = true;
             } else if (data.name === "Move Back") {
                 msgBox.innerHTML = `${pName}: ğŸ”™ <b>Move Back</b> 1 space!`;
             }
             msgBox.style.borderLeftColor = "#546E7A";
             return;
        }

        if (data.type === 'bonus') {
            if (data.name === "Candy Cane") {
                msgBox.innerHTML = `${pName}: ğŸ¬ <b>Candy Cane!</b> Move 1 space forward.`;
            } else if (data.name === "Gingerbread" || data.name === "Move Ahead 2") {
                msgBox.innerHTML = `${pName}: ğŸª <b>${data.name}!</b> Move 2 spaces.`;
            } else if (data.name === "Stockings") {
                msgBox.innerHTML = `${pName}: ğŸ§¦ <b>Stockings!</b> Lucky! Roll Again!`;
            } else if (data.name === "Star") {
                msgBox.innerHTML = `${pName}: â­ <b>Star!</b> Super Bonus!`;
            }
            msgBox.style.borderLeftColor = "#E91E63";
            return;
        }
        
        if (data.type === 'deco') {
            msgBox.innerHTML = `${pName}: ğŸ„ <b>${data.name}</b>. Just relaxing.`;
            msgBox.style.borderLeftColor = "#8BC34A";
            return;
        }

        if (data.type === 'gear') {
            if (!collectedItems.has(data.name)) {
                collectedItems.add(data.name);
                updateVisuals(data.name, true);
                msgBox.innerHTML = `${pName}: ğŸ‰ <b>Found ${data.name}</b> for the Team!`; 
                msgBox.style.borderLeftColor = "#4CAF50";
                if (collectedItems.size === 9) {
                    msgBox.innerHTML = `ğŸ† <b>MISSION COMPLETE!</b> The Team wins!`; 
                    msgBox.style.background = "#FFD700";
                }
            } else {
                msgBox.innerHTML = `${pName}: ğŸ‘ Team already has <b>${data.name}</b>.`; 
                msgBox.style.borderLeftColor = "#81C784";
            }
            return;
        }
    }

    function updateVisuals(name, isVisible) {
        // 1. Update Grid Badge
        const formattedName = name.charAt(0).toUpperCase() + name.slice(1);
        const badge = document.getElementById(`badge-${formattedName}`);
        if (badge) isVisible ? badge.classList.add('active') : badge.classList.remove('active');

        // 2. Update Santa Image
        const layerId = `layer-${formattedName}`;
        const imgLayer = document.getElementById(layerId);
        
        if (imgLayer) {
            if (isVisible) {
                imgLayer.classList.remove('hidden-gear');
                imgLayer.classList.add('visible-gear');
                
                // ç¢ºä¿åœ–ç‰‡é¡¯ç¤º (å¦‚æœä¹‹å‰è¢« onerror éš±è—)
                if (imgLayer.style.display === 'none') {
                    // å¦‚æœæ˜¯æœ¬åœ°åœ–ç‰‡ï¼Œé€™è¡Œå…¶å¯¦æ²’ç”¨ï¼Œå› ç‚ºç€è¦½å™¨å·²ç¶“èªå®šè¼‰å…¥å¤±æ•—
                    // ä½†å¦‚æœæ˜¯ä¹‹å¾Œå‹•æ…‹æ›åœ–ç‰‡ï¼Œé€™è¡Œæœƒæœ‰ç”¨
                    imgLayer.style.display = 'block'; 
                }
            } else {
                imgLayer.classList.remove('visible-gear');
                imgLayer.classList.add('hidden-gear');
            }
        }
    }
</script>

</body>
</html>